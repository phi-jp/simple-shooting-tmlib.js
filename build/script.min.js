var SCREEN_WIDTH=465,SCREEN_HEIGHT=465,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,PLAYER_LEVEL_MAX=2,PLAYER_SIZE=50,PLAYER_IMAGE=null,ENEMY_SIZE=80,ENEMY_IMAGE=null,ENEMY_POS_OFFSET=90,BULLET_SIZE=12,BULLET_IMAGE=null;tm.preload(function(){PLAYER_IMAGE=tm.graphics.Canvas().resize(PLAYER_SIZE,PLAYER_SIZE).setTransformCenter().setColorStyle("white","rgba(200, 200, 200, 0.9)").setLineStyle(4).fillPolygon(0,0,PLAYER_SIZE/2,3).strokePolygon(0,0,PLAYER_SIZE/2,3),ENEMY_IMAGE=tm.graphics.Canvas().resize(ENEMY_SIZE,ENEMY_SIZE).setTransformCenter().setColorStyle("white","red").setLineStyle(4).fillStar(0,0,ENEMY_SIZE/2,16,.6).strokeStar(0,0,ENEMY_SIZE/2,16,.6),BULLET_IMAGE=tm.graphics.Canvas().resize(BULLET_SIZE+4,BULLET_SIZE+4).setTransformCenter().setColorStyle("white","#444").setLineStyle(2).fillCircle(0,0,BULLET_SIZE/2).strokeCircle(0,0,BULLET_SIZE/2),tm.sound.SoundManager.add("bgm","bgm/Loop_35.wav",1),tm.sound.SoundManager.add("crash","se/crash.wav")}),tm.main(function(){var e=tm.app.CanvasApp("#world");e.resize(SCREEN_WIDTH,SCREEN_HEIGHT),e.fitWindow(),e.replaceScene(GameScene());var t=new Stats;t.getDomElement().style.position="fixed",t.getDomElement().style.left="5px",t.getDomElement().style.top="5px",document.body.appendChild(t.getDomElement()),e.update=function(){t.update()},e.run()});var GameScene=tm.createClass({superClass:tm.app.Scene,init:function(){this.superInit();for(var e=0;e<32;++e){var t=tm.util.Random.randint(8,16),n=BGStar(t).addChildTo(this);n.x=tm.util.Random.randint(0,SCREEN_WIDTH),n.y=tm.util.Random.randint(0,SCREEN_HEIGHT)}this.scoreLabel=tm.app.Label(),this.scoreLabel.align="right",this.scoreLabel.addChildTo(this).setPosition(SCREEN_WIDTH-10,30),this.scoreLabel.width=200,this.player=Player().addChildTo(this),this.player.x=SCREEN_CENTER_X,this.player.y=SCREEN_HEIGHT-80},update:function(e){e.frame%4==0&&this.player.shot(e.currentScene);if(e.frame%60==0)for(var t=0;t<5;++t){var n=Enemy().addChildTo(this),r=SCREEN_CENTER_X+ENEMY_POS_OFFSET*(t-2);n.x=r,n.y=-100}for(var t=0,i=Enemy.list.length;t<i;++t){var n=Enemy.list[t];if(this.player.isHitElement(n)){e.stop();break}}for(var t=0,i=Item.list.length;t<i;++t){var s=Item.list[t];if(this.player.isHitElement(s)){s.giveEffect(this.player),s.destroy=!0;break}}for(var t=0,i=Enemy.list.length;t<i;++t){var n=Enemy.list[t];if(n.life<=0)continue;for(var o=0,u=Bullet.list.length;o<u;++o){var a=Bullet.list[o];if(a.destroy<=0)continue;n.isHitElement(a)&&(n.life-=a.power,a.life-=1)}}this.scoreLabel.text=e.frame+" km"}}),BGStar=tm.createClass({superClass:tm.app.Shape,init:function(e){this.superInit(e,e),this.canvas.globalCompositeOperation="lighter";var t=tm.util.Random.randint(0,360);this.canvas.fillStyle="hsla({0}, 75%, 75%, 0.5)".format(t),this.canvas.setTransformCenter(),this.canvas.fillStar(0,0,e/2,4,.5),this.canvas.fillStar(0,0,e/2*.5,4,.5),this.speed=e/2,this.offset=tm.util.Random.randint(0,360)},update:function(e){this.y+=this.speed,this.alpha=(Math.sin(Math.degToRad((e.frame+this.offset)*10))+1)/2,this.y>SCREEN_HEIGHT+20&&(this.y=-20),this.time++}}),Player=tm.createClass({superClass:tm.app.Sprite,init:function(){this.superInit(PLAYER_SIZE,PLAYER_SIZE,PLAYER_IMAGE),this.level=0,this.move=this.moveByPointing},update:function(e){this.move(e);var t=this.width/2,n=SCREEN_WIDTH-this.width/2;this.x<t?this.x=t:this.x>n&&(this.x=n)},moveByPointing:function(e){var t=e.pointing;t.getPointing()&&(this.x+=t.deltaPosition.x*1.5)},moveByAccel:function(e){var t=e.accelerometer,n=t.gravity;this.x+=n.x*4},shot:function(e){switch(this.level){case 0:Bullet().addChildTo(this).addChildTo(e).setPosition(this.x,this.y-30);break;case 1:Bullet().addChildTo(this).addChildTo(e).setPosition(this.x-20,this.y-5),Bullet().addChildTo(this).addChildTo(e).setPosition(this.x+20,this.y-5);break;case 2:Bullet().addChildTo(this).addChildTo(e).setPosition(this.x,this.y-30),Bullet().addChildTo(this).addChildTo(e).setPosition(this.x-20,this.y-5),Bullet().addChildTo(this).addChildTo(e).setPosition(this.x+20,this.y-5);break;default:assert(!1)}}}),Bullet=tm.createClass({superClass:tm.app.Sprite,init:function(){this.superInit(BULLET_SIZE,BULLET_SIZE,BULLET_IMAGE),Bullet.list.push(this),this.power=1,this.life=1},update:function(){this.y-=16;if(this.y<0||this.life<=0)this.remove(),Bullet.list.erase(this)}});Bullet.list=[];var Enemy=tm.createClass({superClass:tm.app.Sprite,init:function(){this.superInit(ENEMY_SIZE,ENEMY_SIZE,ENEMY_IMAGE),Enemy.list.push(this),this.life=2},update:function(e){this.y+=8,this.rotation+=8;if(this.y>SCREEN_HEIGHT+50||this.life<=0){this.remove(),Enemy.list.erase(this);if(this.life<=0){var t=Crash();t.position.set(this.x,this.y),t.addChildTo(e.currentScene),tm.sound.SoundManager.get("crash").play(),tm.util.Random.randint(0,100)<10&&Star().setPosition(this.x,this.y).addChildTo(e.currentScene)}}}});Enemy.list=[];var Crash=tm.createClass({superClass:tm.app.CanvasElement,init:function(){this.superInit(),this.timer=30;var e=this;for(var t=0;t<16;++t){var n=tm.app.Sprite(20,20,ENEMY_IMAGE);n.v=tm.geom.Vector2.random(0,360,2),n.blendMode="lighter",n.update=function(){this.x+=this.v.x,this.y+=this.v.y,this.v.mul(.95),this.alpha=e.timer/30},this.addChild(n)}},update:function(){this.timer-=1,this.timer<=0&&this.remove()},onanimationend:function(){this.remove()}}),Item=tm.createClass({superClass:tm.app.Shape,init:function(){this.superInit(32,32),this.v=tm.geom.Vector2.random(225,315,8),Item.list.push(this)},update:function(){this.v.y+=.25,this.position.add(this.v);var e=this.width/2,t=SCREEN_WIDTH-this.width/2;this.x<e?(this.x=e,this.v.x*=-1):this.x>t&&(this.x=t,this.v.x*=-1),this.destroy&&(this.remove(),Item.list.erase(this))},giveEffect:function(){}});Item.list=[];var Coin=tm.createClass({superClass:Item,init:function(){this.superInit(),this.canvas.setTransformCenter(),this.canvas.scale(.8,1),this.canvas.setFillStyle("yellow").fillCircle(0,0,6),this.canvas.setLineStyle(2).setStrokeStyle("white").strokeCircle(0,0,6)}}),Star=tm.createClass({superClass:Item,init:function(){this.superInit(),this.canvas.setTransformCenter(),this.canvas.setFillStyle("yellow").fillStar(0,0,15,5),this.canvas.setLineStyle(2).setStrokeStyle("white").strokeStar(0,0,15,5)},giveEffect:function(e){e.level=Math.min(e.level+1,PLAYER_LEVEL_MAX)}})