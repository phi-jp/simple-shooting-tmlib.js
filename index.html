<html>
    <head>
        <script src="lib/tmlib.js"></script>
        <script>

var SCREEN_WIDTH    = 465;
var SCREEN_HEIGHT   = 465;
var SCREEN_CENTER_X = SCREEN_WIDTH/2;
var SCREEN_CENTER_Y = SCREEN_HEIGHT/2;
var PLAYER_LEVEL_MAX= 2;
var ENEMY_POS_OFFSET= 90;
var CRASH_STYLE_SHEET = null;

tm.preload(function() {
    tm.graphics.TextureManager.add("player", "https://raw.github.com/phi1618/tmlib.js/rsource0.1.0/resource/img/shooting/player00.png");
    tm.graphics.TextureManager.add("enemy", "https://raw.github.com/phi1618/tmlib.js/rsource0.1.0/resource/img/shooting/enemy.png");
    tm.graphics.TextureManager.add("crash", "http://jsrun.it/assets/q/4/L/I/q4LIU.png");

    tm.sound.SoundManager.add("bgm", "bgm/Loop_35.wav", 1);
    tm.sound.SoundManager.add("crash", "se/crash.wav");
});

tm.main(function() {
    var app = tm.app.CanvasApp("#world");
    app.resize(SCREEN_WIDTH, SCREEN_HEIGHT);
    app.fitWindow();


    CRASH_STYLE_SHEET = tm.app.SpriteSheet({
        image: "crash",
        frame: {
            width: 64,
            height: 64,
            count: 64
        },
        animations: {
            "crash": [0, 32, "crash"],
            "hoge": [32, 0, "crash", 5],
        }
    });


    app.replaceScene(GameScene());

    app.run();
});


var GameScene = tm.createClass({
    superClass: tm.app.Scene,

    init: function() {
        this.superInit();

        /*
        var bgm = tm.sound.SoundManager.get("bgm");
        bgm.loop = true;
        bgm.play();
        */

        this.player = Player().addChildTo(this);
        this.player.x = SCREEN_CENTER_X;
        this.player.y = SCREEN_HEIGHT-100;

    },

    update: function(app) {
        if (app.frame % 4 == 0) {
            this.player.shot(app.currentScene);
        }

        if (app.frame % 60 == 0) {
            for (var i=0; i<5; ++i) {
                var enemy = Enemy().addChildTo(this);
                var x = SCREEN_CENTER_X + ENEMY_POS_OFFSET*(i-2);
//                enemy.x = tm.util.Random.randint(0, SCREEN_WIDTH);
                enemy.x = x;
                enemy.y = -100;
            }
        }

        // プレイヤーとアイテム
        for (var i=0, len=Item.list.length; i<len; ++i) {
            var item = Item.list[i];
            if (this.player.isHitElement(item)) {
                item.giveEffect(this.player);
                item.destroy = true;
                break;
            }
        }

        for (var i=0, len=Enemy.list.length; i<len; ++i) {
            var enemy = Enemy.list[i];
            if (enemy.life <= 0) continue ;

            for (var j=0, len2=Bullet.list.length; j<len2; ++j) {
                var bullet = Bullet.list[j];
                if (bullet.destroy <= 0) continue ;
                if (enemy.isHitElement(bullet)) {
                    enemy.life -= bullet.power;
                    bullet.life -= 1;
                }
            }
       }
    },

    onpointingmove: function(e) {
        var p = e.app.pointing;

        this.player.x += p.deltaPosition.x;

    }
});


var Player = tm.createClass({
    superClass: tm.app.TriangleShape,

    init: function() {
        this.superInit(50, 50, {
            fillStyle: "rgba(200, 200, 200, 0.9)",
        });
        this.level = 0;
    },

    update: function(app) {

    },

    shot: function(scene) {
        switch (this.level) {
            case 0 :
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x, this.y-30);
                break;
            case 1 :
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x-20, this.y-5);
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x+20, this.y-5);
                break;
            case 2 :
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x, this.y-30);
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x-20, this.y-5);
                Bullet().addChildTo(this).addChildTo(scene).setPosition(this.x+20, this.y-5);
                break;
            default :
                assert(false);
                break;
        }

    }
})

var Bullet = tm.createClass({
    superClass: tm.app.CircleShape,

    init: function() {
        this.superInit(12, 12, {
            fillStyle: "#444",
            lineWidth: 2,
        });
        Bullet.list.push(this);

        this.power = 1;
        this.life  = 1;
    },
    update: function() {
        this.y -= 16;

        if (this.y < 0 || this.life <= 0) {
            this.remove();
            Bullet.list.erase(this);
        }
    }
});
Bullet.list = [];


var Enemy = tm.createClass({
    superClass: tm.app.StarShape,

    init: function() {
        this.superInit(80, 80, {
            fillStyle: "red",
            lineWidth: 2.5,
            sides: 16,
            sideIndent: 0.6
        });
        Enemy.list.push(this);

        this.life = 2;
    },
    update: function(app) {
        this.y += 8;
        this.rotation += 8;

        if (this.y > SCREEN_HEIGHT+50 || this.life <= 0) {
            this.remove();
            Enemy.list.erase(this);

            if (this.life <= 0) {
                var crash = Crash();
                crash.position.set(this.x, this.y);
                crash.addChildTo(app.currentScene);
                tm.sound.SoundManager.get("crash").play();

                // アイテム
                if (tm.util.Random.randint(0, 100) < 10) {
                    Star().setPosition(this.x, this.y).addChildTo(app.currentScene);
                }
            }
        }
    }
});
Enemy.list = [];

var Crash = tm.createClass({
    superClass: tm.app.CanvasElement,

    init: function() {
        this.superInit();

        this.timer = 30;
        
        var self = this;
        for (var i=0; i<16; ++i) {
            var particle = tm.app.StarShape(40, 40, {
                fillStyle: "red",
                lineWidth: 2.5,
                sides: 16,
                sideIndent: 0.6
            });
            particle.scaleX = particle.scaleY = 0.5;
            particle.v = tm.geom.Vector2.random(0, 360, 2);
            particle.blendMode = "lighter";
            particle.update = function() {
                this.x += this.v.x;
                this.y += this.v.y;
                this.v.mul(0.95);
                this.alpha = (self.timer/30.0);
            }
            this.addChild(particle);
        }
    },
    update: function() {
        this.timer -= 1;
        if (this.timer <= 0) {
            this.remove();
        }
    },
    onanimationend: function() {
        this.remove();
    }
});

var Item = tm.createClass({
    superClass: tm.app.Shape,

    init: function() {
        this.superInit(16, 16);
        this.v = tm.geom.Vector2.random(225, 315, 8);
        Item.list.push(this);
    },

    update: function() {
        this.v.y += 0.25;
        this.position.add(this.v);

        if (this.x < 0) {
            this.x = 0;
            this.v.x *= -1;
        }
        else if (this.x > SCREEN_WIDTH) {
            this.x = SCREEN_WIDTH;
            this.v.x *= -1;
        }

        if (this.destroy) {
            this.remove();
            Item.list.erase(this);
        }
    },

    giveEffect: function() {

    }
});
Item.list = [];


var Coin = tm.createClass({
    superClass: Item,

    init: function() {
        this.superInit();

        this.canvas.setTransformCenter();
        this.canvas.scale(0.8, 1.0);
        this.canvas.setFillStyle("yellow").fillCircle(0, 0, 6);
        this.canvas.setLineStyle(2).setStrokeStyle("white").strokeCircle(0, 0, 6);
    }
});

var Star = tm.createClass({
    superClass: Item,

    init: function() {
        this.superInit();

        this.canvas.setTransformCenter();
        this.canvas.setFillStyle("yellow").fillStar(0, 0, 6, 5);
        this.canvas.setLineStyle(2).setStrokeStyle("white").strokeStar(0, 0, 6, 5);
    },

    giveEffect: function(player) {
        player.level = Math.min(player.level+1, PLAYER_LEVEL_MAX);
        console.log(player.level);
    }
});



        </script>
    </head>
    <body>
        <canvas id="world"></canvas>
    </body>
</html>